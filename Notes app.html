<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Local Notes App</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Style for the active note card */
        
        .note-card.active {
            background-color: #dbeafe;
            /* blue-100 */
            border-left: 4px solid #3b82f6;
            /* blue-500 */
        }
        /* Make content area scrollable */
        
        .content-scroll {
            overflow-y: auto;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-lg p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center max-w-5xl">
            <h1 class="text-3xl font-extrabold text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m-5 3h4a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg> SafNotes
            </h1>
            <button id="addNewNoteButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                + New Note
            </button>
        </div>
    </header>

    <!-- Main Content Area: Sidebar + Editor -->
    <main class="flex-grow flex flex-col md:flex-row max-w-5xl mx-auto w-full">

        <!-- 1. Sidebar (Note List) -->
        <aside id="sidebar" class="w-full md:w-80 bg-white border-r border-gray-200 p-4 content-scroll h-full md:h-[calc(100vh-80px)]">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Your Notes</h2>
            <div id="notesList" class="space-y-3">
                <!-- Note Cards will be rendered here by JavaScript -->
            </div>
            <div id="emptyListState" class="hidden text-center text-gray-500 mt-8">
                <p>No notes saved yet.</p>
            </div>
        </aside>

        <!-- 2. Editor Panel (Note Detail) -->
        <section id="editorPanel" class="flex-grow p-4 content-scroll md:h-[calc(100vh-80px)]">
            <div id="welcomeState" class="text-center p-12 bg-white rounded-xl shadow-inner mt-8 md:mt-0 border-t-4 border-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <p class="text-xl text-gray-600 font-semibold">Select a Note</p>
                <p class="text-gray-400">Click on a note in the sidebar or hit '+ New Note' to get started.</p>
            </div>

            <form id="noteEditorForm" class="hidden bg-white p-6 rounded-xl shadow-xl border-t-4 border-blue-500">
                <input type="hidden" id="currentNoteId">

                <!-- Title Input -->
                <div class="mb-4">
                    <label for="editorTitle" class="block text-gray-700 text-sm font-bold mb-2">Title</label>
                    <input type="text" id="editorTitle" required class="text-2xl font-semibold shadow-inner border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-800 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Untitled Note">
                </div>

                <!-- Content Textarea -->
                <div class="mb-6">
                    <label for="editorContent" class="block text-gray-700 text-sm font-bold mb-2">Content</label>
                    <textarea id="editorContent" rows="15" required class="shadow-inner border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="Start writing your thoughts here..."></textarea>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <p id="noteDate" class="text-sm text-gray-500"></p>
                    <div class="space-x-3">
                        <button type="button" id="deleteNoteButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Delete
                        </button>
                        <!-- NEW: Done Button -->
                        <button type="button" id="doneEditingButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Done
                        </button>
                        <button type="submit" id="saveNoteButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </section>
    </main>

    <!-- Confirmation Modal (for Delete) -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Deletion</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this note? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('confirmModal').classList.add('hidden')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="confirmDeleteButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const LOCAL_STORAGE_KEY = 'gemini_simple_notes';
        const MAX_PREVIEW_LENGTH = 100;

        // DOM Elements
        const notesListEl = document.getElementById('notesList');
        const emptyListStateEl = document.getElementById('emptyListState');
        const addNewNoteButtonEl = document.getElementById('addNewNoteButton');
        const editorPanelEl = document.getElementById('editorPanel');
        const welcomeStateEl = document.getElementById('welcomeState');
        const noteEditorFormEl = document.getElementById('noteEditorForm');
        const currentNoteIdEl = document.getElementById('currentNoteId');
        const editorTitleEl = document.getElementById('editorTitle');
        const editorContentEl = document.getElementById('editorContent');
        const noteDateEl = document.getElementById('noteDate');
        const deleteNoteButtonEl = document.getElementById('deleteNoteButton');
        const saveNoteButtonEl = document.getElementById('saveNoteButton'); // Added for completeness
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmDeleteButtonEl = document.getElementById('confirmDeleteButton');
        // NEW: Done button element
        const doneEditingButtonEl = document.getElementById('doneEditingButton');

        // State
        let notes = [];
        let selectedNoteId = null;

        // --- Local Storage Functions ---

        /**
         * Loads notes from local storage, sorts them by creation date, and updates the global notes array.
         */
        function loadNotes() {
            const json = localStorage.getItem(LOCAL_STORAGE_KEY);
            notes = json ? JSON.parse(json) : [];

            // Sort by creation date descending (newest first)
            notes.sort((a, b) => b.id - a.id);
        }

        /**
         * Saves the current notes array back to local storage.
         */
        function saveNotes() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(notes));
        }

        /**
         * Clears the editor panel and shows the welcome state.
         */
        function clearEditor() {
            selectedNoteId = null;
            noteEditorFormEl.classList.add('hidden');
            welcomeStateEl.classList.remove('hidden');

            // Remove active state from all note cards
            document.querySelectorAll('.note-card').forEach(card => card.classList.remove('active'));
        }

        // --- Sidebar Rendering ---

        /**
         * Renders the list of notes in the sidebar.
         */
        function renderSidebar() {
            notesListEl.innerHTML = ''; // Clear existing list

            if (notes.length === 0) {
                emptyListStateEl.classList.remove('hidden');
                notesListEl.classList.add('hidden');
                clearEditor();
                return;
            }

            emptyListStateEl.classList.add('hidden');
            notesListEl.classList.remove('hidden');

            notes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = `note-card p-4 rounded-xl cursor-pointer transition duration-150 hover:bg-gray-50 border-l-4 border-transparent ${note.id === selectedNoteId ? 'active' : ''}`;
                noteCard.setAttribute('data-id', note.id);

                // Truncate content for preview
                const contentPreview = note.content.length > MAX_PREVIEW_LENGTH ?
                    note.content.substring(0, MAX_PREVIEW_LENGTH) + '...' :
                    note.content;

                const date = new Date(note.id).toLocaleDateString();

                noteCard.innerHTML = `
                    <h3 class="text-md font-semibold text-gray-800 truncate">${note.title || 'Untitled Note'}</h3>
                    <p class="text-sm text-gray-500 mt-1 mb-2">${contentPreview || 'No content.'}</p>
                    <span class="text-xs text-gray-400">Created: ${date}</span>
                `;

                noteCard.addEventListener('click', () => selectNote(note.id));
                notesListEl.appendChild(noteCard);
            });
        }

        // --- Editor Control ---

        /**
         * Finds a note by ID and displays its content in the main editor panel.
         * @param {number} id - The ID of the note to select.
         */
        function selectNote(id) {
            const note = notes.find(n => n.id === id);

            if (!note) {
                console.error('Note not found:', id);
                return;
            }

            // Update state and UI
            selectedNoteId = id;
            welcomeStateEl.classList.add('hidden');
            noteEditorFormEl.classList.remove('hidden');

            // Populate form
            currentNoteIdEl.value = note.id;
            editorTitleEl.value = note.title;
            editorContentEl.value = note.content;

            // Display date
            noteDateEl.textContent = `Created: ${new Date(note.id).toLocaleString()}`;

            // Re-render sidebar to highlight the active card
            renderSidebar();
        }

        /**
         * Sets up the editor for creating a new note.
         */
        function createNewNote() {
            clearEditor(); // Clear any existing selection

            // Show form for new input
            welcomeStateEl.classList.add('hidden');
            noteEditorFormEl.classList.remove('hidden');

            // Reset form fields
            currentNoteIdEl.value = '';
            editorTitleEl.value = '';
            editorContentEl.value = '';
            noteDateEl.textContent = 'New Note';
            editorTitleEl.focus();

            // Clear active state on all cards
            document.querySelectorAll('.note-card').forEach(card => card.classList.remove('active'));
        }

        // --- CRUD Operations ---

        /**
         * Handles saving (add or update) a note from the editor form.
         * @param {Event} e - The form submit event.
         */
        function handleSaveNote(e) {
            e.preventDefault();

            const id = currentNoteIdEl.value ? Number(currentNoteIdEl.value) : null;
            const title = editorTitleEl.value.trim();
            const content = editorContentEl.value.trim();

            if (!title) {
                // Using console.error instead of alert per instructions
                console.error("Please enter a title for your note.");
                return;
            }

            if (id) {
                // Update existing note
                const index = notes.findIndex(n => n.id === id);
                if (index !== -1) {
                    notes[index].title = title;
                    notes[index].content = content;
                }
            } else {
                // Add new note
                const newNote = {
                    id: Date.now(), // Use timestamp as unique ID
                    title: title,
                    content: content,
                };
                notes.push(newNote);
                // Immediately select the new note
                selectedNoteId = newNote.id;
            }

            saveNotes();
            loadNotes(); // Reloads and sorts
            renderSidebar();

            // If a new note was created, re-select it to update the editor fields
            if (!id) {
                selectNote(selectedNoteId);
            }
        }

        // NEW: Function to handle exiting the editor
        function handleDoneEditing() {
            clearEditor();
        }

        let noteIdToDelete = null;

        /**
         * Opens the confirmation modal for deletion.
         */
        function openDeleteModal() {
            if (selectedNoteId) {
                noteIdToDelete = selectedNoteId;
                confirmModalEl.classList.remove('hidden');
            } else {
                console.warn('No note selected for deletion.');
            }
        }

        /**
         * Executes the deletion of the confirmed note.
         */
        function confirmDeleteNote() {
            if (!noteIdToDelete) return;

            // Filter out the note to delete
            notes = notes.filter(n => n.id !== noteIdToDelete);
            saveNotes();
            loadNotes(); // Reloads and sorts

            // Clear the editor panel and close modal
            clearEditor();
            confirmModalEl.classList.add('hidden');
            noteIdToDelete = null;
            renderSidebar();
        }

        // --- Event Listeners and Initialization ---

        // Attach event listeners
        addNewNoteButtonEl.addEventListener('click', createNewNote);
        noteEditorFormEl.addEventListener('submit', handleSaveNote);
        deleteNoteButtonEl.addEventListener('click', openDeleteModal);
        confirmDeleteButtonEl.addEventListener('click', confirmDeleteNote);

        // NEW: Attach event listener for Done button
        doneEditingButtonEl.addEventListener('click', handleDoneEditing);

        // Initial load
        window.onload = () => {
            loadNotes();
            renderSidebar();
        };

        // Simple modal close function
        window.closeModal = (event) => {
            if (event.target.id === 'confirmModal') {
                event.target.classList.add('hidden');
            }
        };
    </script>
</body>

</html>